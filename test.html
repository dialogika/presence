<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Presensi Intern</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; padding: 20px; }
        
        /* HEADER UTAMA */
        .main-header {
            background-color: #0B2B6A;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
            border-bottom: 3px solid #f39c12;
        }

        .table-section {
            background: white;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .month-title {
            color: #0B2B6A;
            font-weight: 700;
            margin: 15px 0 10px 0;
            text-transform: uppercase;
            border-left: 5px solid #1c84e3;
            padding-left: 10px;
        }

        table {
            font-size: 0.9rem;
            border-collapse: collapse;
            width: 100%;
            white-space: nowrap;
        }

        /* HEADER TABEL */
        thead th {
            background-color: #1c84e3 !important;
            color: white !important;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
            padding: 10px 5px;
        }

        .th-name { 
            background-color: #1c84e3 !important; 
            position: sticky; 
            left: 0; 
            z-index: 2;
            min-width: 200px;
            border-right: 2px solid #ddd;
        }

        tbody td {
            border: 1px solid #dee2e6;
            text-align: center;
            padding: 8px;
            vertical-align: middle;
        }

        .td-name {
            background-color: #fff;
            position: sticky;
            left: 0;
            z-index: 1;
            font-weight: 600;
            text-align: left !important;
            padding-left: 15px !important;
            border-right: 2px solid #dee2e6 !important;
            color: #333;
        }

        /* HIGHLIGHT HARI INI */
        .today-header { background-color: #198754 !important; border: 2px solid #fff; }
        .today-column { background-color: #f1f8e9; }

        /* SIMBOL STATUS */
        .symbol-hadir {
            color: #006a4e; /* Hijau */
            font-weight: 900;
            font-size: 1.4rem;
            cursor: pointer;
            line-height: 1;
        }
        .symbol-hadir:hover { transform: scale(1.2); display: inline-block; transition: 0.2s; }

        .symbol-izin {
            color: #f7b12c; /* Kuning Segitiga */
            font-weight: 900;
            font-size: 1.4rem;
            line-height: 1;
        }

        .symbol-alfa {
            color: #dc3545; /* Merah X */
            font-weight: 900;
            font-size: 1.2rem;
            line-height: 1;
        }

        .badge-score { font-size: 0.9rem; padding: 6px; display: block; width: 100%; border-radius: 4px; color: white; }
        .score-good { background-color: #006a4e; }
        .score-mid  { background-color: #f7b12c; }
        .score-bad  { background-color: #dc3545; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container-fluid p-0">
    <div class="main-header">
        <h3 class="fw-bold mb-0">DATA PRESENSI INTERN</h3>
        <small style="opacity: 0.8;">Real-time data from ClickUp</small>
    </div>
    
    <div id="loading" class="text-center py-5 bg-white border">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Synchronizing data...</p>
    </div>

    <div id="tablesContainer" class="hidden"></div>
</div>

<!-- Modal Detail Durasi -->
<div class="modal fade" id="durationModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header text-white" style="background-color: #1c84e3;">
        <h5 class="modal-title fw-bold">Detail Kehadiran</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-1 text-muted">Jam Masuk</p>
        <h3 id="modalJamMasuk" class="fw-bold text-dark">10:00</h3>
        <hr>
        <p class="mb-1 text-muted">Durasi Kerja</p>
        <h2 id="modalDurasi" class="fw-bold" style="color: #006a4e;">7 Jam</h2>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // URL Backend Google Script
    const API_URL = "https://script.google.com/macros/s/AKfycbyPUXK2NptrsbOEuAgEfo6S1sNDzaHVQbvwExoPyxk6aylvQ8xKSGu6uBcW6A7plu61/exec";

    document.addEventListener("DOMContentLoaded", async function() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            if(data.error) { alert("Error: " + data.error); return; }
            processAndRender(data);
        } catch (e) {
            console.error(e);
            alert("Gagal koneksi. Cek internet.");
        }
    });

    function processAndRender(logs) {
        // 1. Group Data Berdasarkan Bulan
        const groupedByMonth = {};
        const now = new Date();
        const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        groupedByMonth[currentMonthKey] = []; // Inisialisasi Bulan Ini

        logs.forEach(log => {
            const monthKey = log.date.substring(0, 7);
            if (!groupedByMonth[monthKey]) groupedByMonth[monthKey] = [];
            groupedByMonth[monthKey].push(log);
        });

        // 2. Sort Bulan Descending (Terbaru di atas)
        const sortedMonths = Object.keys(groupedByMonth).sort().reverse();
        const container = document.getElementById("tablesContainer");
        container.innerHTML = "";

        sortedMonths.forEach(monthKey => {
            const [year, month] = monthKey.split('-').map(Number);
            const htmlTable = generateMonthTable(year, month, groupedByMonth[monthKey]);
            container.innerHTML += htmlTable;
        });

        document.getElementById("loading").classList.add("hidden");
        container.classList.remove("hidden");
    }

    function generateMonthTable(year, month, logs) {
        const monthName = new Date(year, month - 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
        
        // Mapping Data Karyawan
        const employees = {};
        logs.forEach(log => {
            if (!employees[log.name]) employees[log.name] = {};
            // Jika ada duplikat, ambil data terakhir
            employees[log.name][log.date] = log;
        });

        const workDays = getWorkDaysInMonth(year, month);
        
        // GENERATE HEADER
        let thead = `<thead><tr><th class="th-name" rowspan="2">NAME</th>`;
        workDays.forEach(day => {
            const isToday = isDateToday(day.dateObj);
            thead += `<th class="${isToday ? 'today-header' : ''}">${day.dayName}<br>${day.dateNum}</th>`;
        });
        thead += `<th rowspan="2">HOURS</th><th rowspan="2">DAYS</th><th rowspan="2">% SCORE</th></tr></thead>`;

        // GENERATE BODY
        let tbody = "<tbody>";
        const sortedNames = Object.keys(employees).sort();

        if (sortedNames.length === 0) {
            tbody += `<tr><td colspan="${workDays.length + 4}" class="text-center py-3">No data available for this month.</td></tr>`;
        }

        sortedNames.forEach(name => {
            const empData = employees[name];
            let rowHtml = `<tr><td class="td-name">${name}</td>`;
            let totalHours = 0;
            let totalHadir = 0;

            workDays.forEach(day => {
                const dateStr = day.dateStr;
                const log = empData[dateStr];
                const isToday = isDateToday(day.dateObj);
                const colClass = isToday ? 'today-column' : '';
                
                let cellContent = "";
                
                // LOGIKA SIMBOL
                // 1. Cek Apakah ada Log di Tanggal ini?
                if (log) {
                    // Normalize status string (antisipasi huruf kecil/besar)
                    const status = log.status.toLowerCase();

                    if (status.includes("izin")) {
                        // SEGITIGA KUNING (Izin)
                        cellContent = `<span class="symbol-izin">&#9650;</span>`;
                    } else {
                        // Default "Hadir" atau status kosong tapi ada log (karena backend force "Hadir")
                        // CENTANG HIJAU (Hadir)
                        totalHadir++;
                        const jamMasuk = log.time || "10:00";
                        const duration = calculateDuration(jamMasuk);
                        totalHours += duration;
                        cellContent = `<span class="symbol-hadir" onclick="showDuration('${jamMasuk}', ${duration})">&#10004;</span>`;
                    }
                } else {
                    // Tidak ada log
                    if (isDatePassed(day.dateObj)) {
                        // Tanggal sudah lewat + Tidak ada log = ALPHA (SILANG MERAH)
                        cellContent = `<span class="symbol-alfa">&#10005;</span>`;
                    } else {
                        // Tanggal belum lewat (Hari ini belum absen / Besok) = STRIP
                        cellContent = `<span style="color:#ccc;">-</span>`;
                    }
                }
                
                rowHtml += `<td class="${colClass}">${cellContent}</td>`;
            });

            // Hitung Score
            const validDaysCount = countDaysUntilNow(workDays);
            let percent = 0;
            if(validDaysCount > 0) percent = Math.round((totalHadir / validDaysCount) * 100);

            let badgeClass = "score-bad";
            if(percent > 75) badgeClass = "score-good";
            else if(percent >= 50) badgeClass = "score-mid";

            rowHtml += `<td class="fw-bold">${totalHours}</td><td class="fw-bold">${totalHadir}</td><td><span class="badge-score ${badgeClass}">${percent}%</span></td></tr>`;
            tbody += rowHtml;
        });

        tbody += "</tbody>";

        return `<div class="table-section"><h5 class="month-title">${monthName}</h5><table class="table table-bordered mb-0">${thead}${tbody}</table></div>`;
    }

    // --- HELPER FUNCTIONS ---
    function getWorkDaysInMonth(year, month) {
        const date = new Date(year, month - 1, 1);
        const days = [];
        while (date.getMonth() === month - 1) {
            const dayIdx = date.getDay(); 
            // Tue(2), Thu(4), Sat(6), Sun(0)
            if ([0, 2, 4, 6].includes(dayIdx)) {
                days.push({
                    dateObj: new Date(date),
                    dateStr: `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`,
                    dateNum: String(date.getDate()).padStart(2,'0'),
                    dayName: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][dayIdx]
                });
            }
            date.setDate(date.getDate() + 1);
        }
        return days;
    }

    function isDateToday(dateObj) {
        const now = new Date();
        return dateObj.getDate() === now.getDate() && dateObj.getMonth() === now.getMonth() && dateObj.getFullYear() === now.getFullYear();
    }

    function isDatePassed(dateObj) {
        const now = new Date();
        now.setHours(0,0,0,0);
        const target = new Date(dateObj);
        target.setHours(0,0,0,0);
        return target < now; 
    }

    function countDaysUntilNow(workDaysList) {
        const now = new Date();
        now.setHours(23,59,59,999);
        let count = 0;
        workDaysList.forEach(d => { if (d.dateObj <= now) count++; });
        return count;
    }

    function calculateDuration(timeStr) {
        if(!timeStr || timeStr === "-") return 0;
        const hourIn = parseInt(timeStr.split(":")[0]);
        let dur = 17 - hourIn;
        return dur < 0 ? 0 : dur;
    }

    function showDuration(jam, durasi) {
        document.getElementById("modalJamMasuk").innerText = jam + " WIB";
        document.getElementById("modalDurasi").innerText = durasi + " Hours";
        var myModal = new bootstrap.Modal(document.getElementById('durationModal'));
        myModal.show();
    }
</script>

</body>
</html>